## Purpose

This folder defines an Acorn service which allows to create a database managed by the Exoscale cloud provider. This service currently creates *redis*, *postgres* or *mysql* database depending on the argument provided (more on that below).

## Prerequisites

To use this service you need to have an [Exoscale](https://exoscale.com) account and a public/private key pair with DBaaS permissions

For this demo I set those 2 keys in the following environment variables:

- EXOSCALE_API_KEY
- EXOSCALE_API_SECRET

We will use these environment variables in the next part.

## Definition of the service

The [Acornfile](./service/Acornfile) defining the service contains 4 top level keys:
- args
- service (*exo-dbaas*)
- job (*create-exo-dbaas-service*)
- secrets (*db-creds* and *exo-creds*)

The *args* key define the arguments which can be used to configure the service (type of database, plan to use, ...)

The *exo-dbaas* service is generated by the job *create-exo-dbaas-service*. This job contains all the logic to create a database managed by Exoscale. Behind the hood the database's generation process is done in a container built with this [Dockerfile](./service/Dockerfile). This container calls [render.sh](./service/render.sh) to create the database.

The *db-creds* secret is generated by the job *create-exo-dbaas-service*, it contains the credentials of the database user.

The *exo-creds* secret defines an external secret containing the credentials to connect to the Exoscale account. This secret must exist in the Acorn project before the service can be used.

## Running the service

First we need to create the secret *exo-creds* providing the public and private keys.

Note: the following example uses environment variables already defined in the current shell 

```
acorn secrets create \
  --type opaque \
  --data api_key=$EXOSCALE_API_KEY \
  --data api_secret=$EXOSCALE_API_SECRET \
  exo-creds
```

Next we run the Acorn as follows

```
acorn run -n demo-redis .
```

In a few tens of seconds a new Redis database is up and running.

By default a Redis database is launched but we could create a *Postgres* or a *MySQL* database using the *--type* argument:

```
# Running an Acorn app triggering the creation of a Postgress database
acorn run -n demo-pg . --name=demo-pg --type=pg

# Running an Acorn app triggering the creation of a MySQL database
acorn run -n demo-mysql . --name=demo-mysql --type=mysql
```

![Exoscale managed databases](./images/dbs.png)

Then we can delete the 3 applications we created, this will delete the associated databases:

```
acorn rm db --all --force
acorn rm demo-mysql -af
acorn rm demo-pg -af
```

## Publishing the service

The idea is not to run the service from its own Acornfile (as we did above) but mainly to use the service within other Acorns. For this purpose we first need to build the image of the service (as we would do for a standard Acorn application):

```
VERSION=v...
acorn build -t docker.io/lucj/acorn-exo-dbaas-service:$VERSION -t docker.io/lucj/acorn-exo-dbaas-service:latest .
```

Next we push the image to an OCI registry (Docker Hub in this example):

```
acorn push docker.io/lucj/acorn-exo-dbaas-service:$VERSION
acorn push docker.io/lucj/acorn-exo-dbaas-service:latest
```

![Acorn image available in the Docker Hub](./images/dockerhub.png)

Once the image is in the registry it can be used by other applications.

## Using the service

As we have done when running the service from its own Acornfile, we need to create a secret containing the Exoscale api keys (this secret will allow the job to connect to the Exoscale account).

Notes:
- the following example uses environment variables already defined in the current shell 
- if you have already created the secret in the previous step there is no need to run the command once again

```
acorn secrets create \
  --type opaque \
  --data api_key=$EXOSCALE_API_KEY \
  --data api_secret=$EXOSCALE_API_SECRET \
  exo-creds
```

### Using the service with a simple container

The following Acornfile defines 2 items:
- a reference to the *exo-dbaas* service
- a container named *app* using this service

The container only tries to connect to the Redis database using the URI provided in the env variable, this one is created from the service's properties: 

```
services: "exo-dbaas": {
    image: "docker.io/lucj/acorn-exo-dbaas-service"
}

containers: app: {
  image: "redis"
  entrypoint: ["/bin/sh", "-c", "/check-db.sh"]
  env: {
    URI: "@{services.exo-dbaas.data.proto}://@{services.exo-dbaas.secrets.db-creds.username}:@{services.exo-dbaas.secrets.db-creds.password}@@{services.exo-dbaas.address}:@{services.exo-dbaas.ports}"
  }
  files: "/check-db.sh": """
    echo "Will try to connect to [${URI}]"
    while true; do
      echo "=> testing DB connection..."
      redis-cli -u $URI --tls --insecure ping 2>/dev/null
      if [ $? -eq 0 ]; then
        break
      else
        sleep 5
      fi
    done
    echo "connected to the DB"
    sleep 3600
  """
}
```

This simple application can be run with the following command:

```
acorn run -n app
```

Also, from the *app* container logs we can see the connection was successfull after a couple of minutes (as soon as the database is available):

```
$ acorn logs app
acorn logs app
app-6c74cbbb88-n6hfc: Will try to connect to [rediss://default:xxx@demo-exoscale-90de5c3d-9862-4996-a360-1a56c5773311.aivencloud.com:21700]
app-6c74cbbb88-n6hfc: => testing DB connection...
...
app-6c74cbbb88-n6hfc: => testing DB connection...
app-6c74cbbb88-n6hfc: PONG
app-6c74cbbb88-n6hfc: connected to the DB
```

Everything seems fine BUT the application currently stay in "pending create", still need to figure out why:

```
root@acorn:~/ngs/client# acorn all

APPS:
NAME            IMAGE          HEALTHY   UP-TO-DATE   CREATED   ENDPOINTS   MESSAGE
app             2eeca458c120   1         1            69s ago               [services: exo-dbaas: [pending create]]
app.exo-dbaas   8269ccde8728   0         0            69s ago               OK

CONTAINERS:
NAME                      APP       IMAGE     STATE     RESTARTCOUNT   CREATED   MESSAGE
app.app-f5595ddf8-djb8w   app       redis     running   0              59s ago   

VOLUMES:
NAME      APP-NAME   BOUND-VOLUME   CAPACITY   VOLUME-CLASS   STATUS    ACCESS-MODES   CREATED

SECRETS:
NAME                     TYPE      KEYS                   CREATED
app.exo-dbaas.db-creds   opaque    [password username]    59s ago
exo-creds                opaque    [api_key api_secret]   4h3m ago
```

We can then remove the application, this will remove the database at the same time

```
acorn rm app -af
```

### Using the service's argument

By default the service triggers the creation of a *redis* database but it can be configured to created a *postgres* or a *mysql* database instead. In order to change the database type we need to specify this type as a *serviceArgs* as follows:

```
services: "exo-dbaas": {
    image: "docker.io/lucj/acorn-exo-dbaas-service"
    serviceArgs: {
      type: "pg"
    }
}
containers: app: {
  ...a postgresql client should be defined here...
}
```

Running this Acorn will trigger the creation of a *postgres* database.

## Status

This service is currently a WIP...